name: Cross-Platform Build (macOS Runner Alternative)

# macOS runner ëŒ€ê¸°ì—´ ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ëŒ€ì•ˆì  ì ‘ê·¼
# Linux runnerì—ì„œ macOS í˜¸í™˜ íŒ¨í‚¤ì§€ ìƒì„±

on:
  workflow_dispatch:
    inputs:
      package_type:
        description: 'Package type to build'
        required: true
        default: 'app-bundle'
        type: choice
        options:
        - app-bundle
        - zip-package
        - tarball
  push:
    branches: [ main ]
    paths:
    - '**.py'
    - 'requirements.txt'

jobs:
  # Linuxì—ì„œ macOS í˜¸í™˜ íŒ¨í‚¤ì§€ ìƒì„±
  build-cross-platform:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # ë§¤ìš° ë¹ ë¦„

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install -r requirements.txt
        # macOS í˜¸í™˜ì„±ì„ ìœ„í•œ ì¶”ê°€ ë„êµ¬
        pip install zipapp

    - name: ğŸ—ï¸ Create macOS App Bundle Structure
      run: |
        echo "ğŸ—ï¸ Creating macOS compatible app bundle..."

        APP_NAME="CARRY Route Optimizer.app"
        VERSION="1.0.0"

        # macOS ì•± êµ¬ì¡° ìƒì„±
        mkdir -p "$APP_NAME/Contents/"{MacOS,Resources,Frameworks}

        # Info.plist ìƒì„±
        cat > "$APP_NAME/Contents/Info.plist" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>CARRY_Route_Optimizer</string>
    <key>CFBundleIdentifier</key>
    <string>com.carry.routeoptimizer</string>
    <key>CFBundleName</key>
    <string>CARRY Route Optimizer</string>
    <key>CFBundleDisplayName</key>
    <string>CARRY Route Optimizer</string>
    <key>CFBundleVersion</key>
    <string>$VERSION</string>
    <key>CFBundleShortVersionString</key>
    <string>$VERSION</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>NSHighResolutionCapable</key>
    <true/>
    <key>LSMinimumSystemVersion</key>
    <string>10.15</string>
    <key>NSAppleEventsUsageDescription</key>
    <string>CARRY Route Optimizer needs access for route optimization features.</string>
    <key>NSLocationWhenInUseUsageDescription</key>
    <string>CARRY Route Optimizer uses location for better route suggestions.</string>
</dict>
</plist>
EOF

        # ì‹¤í–‰ ê°€ëŠ¥í•œ ëŸ°ì²˜ ìŠ¤í¬ë¦½íŠ¸
        cat > "$APP_NAME/Contents/MacOS/CARRY_Route_Optimizer" << 'EOF'
#!/bin/bash
# CARRY Route Optimizer - Cross-platform compatible launcher

set -e

echo "ğŸš€ CARRY Route Optimizer Starting..."

# ì‹¤í–‰ ë””ë ‰í† ë¦¬ í™•ì¸
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RESOURCES_DIR="$SCRIPT_DIR/../Resources"

if [[ ! -d "$RESOURCES_DIR" ]]; then
    echo "âŒ Resources directory not found: $RESOURCES_DIR"
    exit 1
fi

cd "$RESOURCES_DIR"

# Python ê²½ë¡œ ì„¤ì •
export PYTHONPATH="$RESOURCES_DIR:$PYTHONPATH"

# Python ì‹¤í–‰ (ì—¬ëŸ¬ ê²½ë¡œ ì‹œë„)
PYTHON_PATHS=(
    "/usr/local/bin/python3"
    "/opt/homebrew/bin/python3"
    "/usr/bin/python3"
    "python3"
    "python"
)

for py_path in "${PYTHON_PATHS[@]}"; do
    if command -v "$py_path" >/dev/null 2>&1; then
        echo "âœ… Using Python: $py_path"

        # Python ë²„ì „ í™•ì¸
        py_version=$("$py_path" --version 2>&1)
        echo "ğŸ“ Python version: $py_version"

        # í•„ìˆ˜ ëª¨ë“ˆ í™•ì¸
        if "$py_path" -c "import PyQt6" 2>/dev/null; then
            echo "âœ… PyQt6 available"
        else
            echo "âš ï¸ PyQt6 not found. Installing..."
            "$py_path" -m pip install PyQt6 --user --quiet || {
                echo "âŒ Failed to install PyQt6. Please install manually:"
                echo "   pip3 install PyQt6"
                exit 1
            }
        fi

        # ì•± ì‹¤í–‰
        exec "$py_path" gui_perfect.py "$@"
    fi
done

echo "âŒ Python 3 not found. Please install Python 3.8+ from python.org"
exit 1
EOF

        chmod +x "$APP_NAME/Contents/MacOS/CARRY_Route_Optimizer"

        # Resources ë³µì‚¬
        echo "ğŸ“‚ Copying resources..."
        cp *.py "$APP_NAME/Contents/Resources/" 2>/dev/null || true
        cp .env "$APP_NAME/Contents/Resources/" 2>/dev/null || true
        [[ -d src ]] && cp -r src "$APP_NAME/Contents/Resources/" || true

        # requirements.txt í¬í•¨ (ëŸ°íƒ€ì„ ì˜ì¡´ì„± ì„¤ì¹˜ìš©)
        cp requirements.txt "$APP_NAME/Contents/Resources/" 2>/dev/null || true

        echo "âœ… App bundle structure created"
        find "$APP_NAME" -type f | head -10

    - name: ğŸ“¦ Create Distribution Packages
      run: |
        echo "ğŸ“¦ Creating multiple distribution formats..."

        APP_NAME="CARRY Route Optimizer.app"
        TIMESTAMP=$(date +%Y%m%d-%H%M)

        # 1. ZIP íŒ¨í‚¤ì§€ (ê°€ì¥ í˜¸í™˜ì„± ì¢‹ìŒ)
        zip -r "CARRY-Route-Optimizer-macOS-${TIMESTAMP}.zip" "$APP_NAME"

        # 2. TAR.GZ íŒ¨í‚¤ì§€ (Unix ê³„ì—´ ì„ í˜¸)
        tar -czf "CARRY-Route-Optimizer-macOS-${TIMESTAMP}.tar.gz" "$APP_NAME"

        # 3. ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ì™€ í•¨ê»˜ íŒ¨í‚¤ì§€
        cat > install_macos.sh << 'EOF'
#!/bin/bash
# CARRY Route Optimizer macOS ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸

set -e

echo "ğŸš€ CARRY Route Optimizer macOS ì„¤ì¹˜ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

# ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
if [[ $EUID -eq 0 ]]; then
   echo "âš ï¸ ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•˜ì§€ ë§ˆì„¸ìš”."
   exit 1
fi

APP_NAME="CARRY Route Optimizer.app"
INSTALL_DIR="/Applications"

# Python ì„¤ì¹˜ í™•ì¸
if ! command -v python3 >/dev/null 2>&1; then
    echo "âŒ Python 3ì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
    echo "ğŸ“¥ Python 3.8 ì´ìƒì„ python.orgì—ì„œ ì„¤ì¹˜í•´ì£¼ì„¸ìš”."
    open "https://www.python.org/downloads/macos/"
    exit 1
fi

echo "âœ… Python í™•ì¸ë¨: $(python3 --version)"

# ì•± ì„¤ì¹˜
if [[ -d "$APP_NAME" ]]; then
    echo "ğŸ“± ì• í”Œë¦¬ì¼€ì´ì…˜ì„ /Applicationsë¡œ ë³µì‚¬í•©ë‹ˆë‹¤..."

    # ê¸°ì¡´ ì•± ì œê±° (ìˆë‹¤ë©´)
    if [[ -d "$INSTALL_DIR/$APP_NAME" ]]; then
        echo "ğŸ—‘ï¸ ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì œê±° ì¤‘..."
        rm -rf "$INSTALL_DIR/$APP_NAME"
    fi

    # ìƒˆ ì•± ë³µì‚¬
    cp -R "$APP_NAME" "$INSTALL_DIR/"

    echo "âœ… ì„¤ì¹˜ ì™„ë£Œ!"
    echo ""
    echo "ğŸ¯ ì‚¬ìš© ë°©ë²•:"
    echo "1. Finder > Applications > CARRY Route Optimizer"
    echo "2. ì²« ì‹¤í–‰ì‹œ 'í™•ì¸ë˜ì§€ ì•Šì€ ê°œë°œì' ê²½ê³ ê°€ ë‚˜íƒ€ë‚˜ë©´:"
    echo "   - ì‹œìŠ¤í…œ ì„¤ì • > ê°œì¸ì •ë³´ ë³´í˜¸ ë° ë³´ì•ˆ > í™•ì¸ ì—†ì´ ì—´ê¸°"
    echo "   - ë˜ëŠ” ì•±ì„ ìš°í´ë¦­ > ì—´ê¸°"
    echo ""
    echo "ğŸ’¡ í•„ìš”í•œ Python íŒ¨í‚¤ì§€ê°€ ìë™ìœ¼ë¡œ ì„¤ì¹˜ë©ë‹ˆë‹¤."

else
    echo "âŒ $APP_NAMEì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    echo "ì••ì¶•ì„ í•´ì œí–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."
    exit 1
fi
EOF

        chmod +x install_macos.sh

        # ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ì™€ í•¨ê»˜ íŒ¨í‚¤ì§€
        zip -r "CARRY-Route-Optimizer-macOS-WithInstaller-${TIMESTAMP}.zip" \
            "$APP_NAME" install_macos.sh

        echo "âœ… ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± ì™„ë£Œ:"
        ls -la *.zip *.tar.gz

    - name: ğŸ§ª Package Validation
      run: |
        echo "ğŸ§ª íŒ¨í‚¤ì§€ ê²€ì¦ ì¤‘..."

        # ZIP íŒ¨í‚¤ì§€ ê²€ì¦
        for file in *.zip; do
            if [[ -f "$file" ]]; then
                echo "ğŸ“¦ $file: $(du -sh "$file" | cut -f1)"
                # ZIP ë‚´ìš© ê°„ë‹¨ í™•ì¸
                unzip -l "$file" | head -5
                echo "---"
            fi
        done

    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CARRY-Route-Optimizer-CrossPlatform
        path: |
          *.zip
          *.tar.gz
          install_macos.sh
        retention-days: 30

    - name: âœ… Build Complete
      run: |
        echo "ğŸ‰ í¬ë¡œìŠ¤ í”Œë«í¼ ë¹Œë“œ ì™„ë£Œ!"
        echo "================================"
        echo ""
        echo "ğŸ“¦ ìƒì„±ëœ íŒ¨í‚¤ì§€:"
        ls -la *.zip *.tar.gz 2>/dev/null || echo "íŒ¨í‚¤ì§€ ì—†ìŒ"
        echo ""
        echo "ğŸ’¡ ì‚¬ìš© ë°©ë²•:"
        echo "1. Artifactsì—ì„œ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ"
        echo "2. ZIP íŒŒì¼ ì••ì¶• í•´ì œ"
        echo "3. install_macos.sh ì‹¤í–‰ ë˜ëŠ”"
        echo "4. ì•±ì„ ì§ì ‘ Applications í´ë”ë¡œ ë“œë˜ê·¸"
        echo ""
        echo "ğŸš€ macOS runner ì—†ì´ë„ ë¹Œë“œ ì„±ê³µ!"