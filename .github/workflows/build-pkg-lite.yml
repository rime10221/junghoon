name: Build PKG (Lite - Queue Bypass)

# macOS runner ëŒ€ê¸°ì—´ ë¬¸ì œ ìš°íšŒìš© ê²½ëŸ‰ ë¹Œë“œ
# í•„ìˆ˜ ê¸°ëŠ¥ë§Œ í¬í•¨í•˜ì—¬ ë¹Œë“œ ì‹œê°„ ìµœì†Œí™”

on:
  workflow_dispatch:
    inputs:
      urgent_build:
        description: 'Urgent build (skips some checks)'
        required: false
        type: boolean
        default: true

# ë¦¬ì†ŒìŠ¤ ì ˆì•½ì„ ìœ„í•œ ì œí•œ
concurrency:
  group: lite-build-${{ github.ref }}
  cancel-in-progress: true

env:
  # ë¹Œë“œ ìµœì í™” í™˜ê²½ë³€ìˆ˜
  PYTHONUNBUFFERED: 1
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  PIP_NO_WARN_SCRIPT_LOCATION: 1
  HOMEBREW_NO_AUTO_UPDATE: 1

jobs:
  quick-build:
    runs-on: macos-13
    timeout-minutes: 25  # ì§§ì€ íƒ€ìž„ì•„ì›ƒìœ¼ë¡œ í ìš°ì„ ìˆœìœ„ í–¥ìƒ

    steps:
    - name: âš¡ Quick Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ðŸ Setup Python (Minimal)
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: âš¡ Install Core Dependencies Only
      run: |
        echo "âš¡ Lightning fast dependency install..."

        # ìµœì†Œí•œì˜ pip ì—…ê·¸ë ˆì´ë“œ
        python3 -m pip install --upgrade pip --quiet

        # í•µì‹¬ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜ (ë¹ ë¥¸ ë¹Œë“œ)
        pip install --quiet --no-warn-script-location \
          PyQt6 pandas requests python-dotenv click openpyxl

    - name: ðŸš€ Ultra Fast Build
      run: |
        echo "ðŸš€ Ultra fast PKG build..."

        APP="CARRY Route Optimizer.app"
        PKG="CARRY-Route-Optimizer-Lite-$(date +%H%M).pkg"

        # ì •ë¦¬
        rm -rf "$APP" *.pkg pkg_*

        # ìµœì†Œ ì•± êµ¬ì¡° (ì´ˆê³ ì†)
        mkdir -p "$APP/Contents/"{MacOS,Resources}

        # ê°„ë‹¨í•œ Info.plist
        cat > "$APP/Contents/Info.plist" << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key><string>start</string>
    <key>CFBundleIdentifier</key><string>com.carry.routeoptimizer</string>
    <key>CFBundleName</key><string>CARRY Route Optimizer</string>
    <key>CFBundleVersion</key><string>1.0.0</string>
    <key>CFBundlePackageType</key><string>APPL</string>
</dict>
</plist>
EOF

        # ì´ˆê°„ë‹¨ ëŸ°ì²˜
        cat > "$APP/Contents/MacOS/start" << 'EOF'
#!/bin/bash
cd "$(dirname "$0")/../Resources"
exec python3 gui_perfect.py "$@"
EOF
        chmod +x "$APP/Contents/MacOS/start"

        # íŒŒì¼ ë³µì‚¬ (ë¹ ë¥´ê²Œ)
        cp gui_perfect.py main.py .env "$APP/Contents/Resources/"
        cp -r src "$APP/Contents/Resources/"

        # ì´ˆê³ ì† PKG ìƒì„±
        mkdir -p pkg/Applications
        cp -R "$APP" pkg/Applications/

        pkgbuild --root pkg --identifier com.carry.routeoptimizer \
                 --version 1.0.0 --install-location / --quiet "$PKG"

        echo "âœ… Lightning build complete: $PKG ($(du -sh "$PKG" | cut -f1))"

    - name: ðŸ“¤ Upload Result
      uses: actions/upload-artifact@v4
      with:
        name: CARRY-PKG-Lite-${{ github.run_number }}
        path: "*.pkg"
        retention-days: 7  # ì§§ì€ ë³´ê´€ ê¸°ê°„

    - name: âš¡ Success Summary
      run: |
        echo "âš¡ LIGHTNING BUILD SUCCESS!"
        echo "========================="
        echo "ðŸ“¦ PKG: $(ls *.pkg)"
        echo "â±ï¸ Build time: ~3-5 minutes"
        echo "ðŸŽ¯ Ready for download!"