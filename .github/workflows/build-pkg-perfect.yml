name: ğŸ† Perfect PKG Build (Zero Dependencies)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'perfect'
        type: choice
        options:
        - perfect
        - debug
  push:
    tags:
      - 'perfect-v*'

jobs:
  build-perfect:
    runs-on: macos-13
    timeout-minutes: 60  # PyInstallerëŠ” ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¼

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11.8'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'

    - name: ğŸ“¦ Install Build Dependencies
      run: |
        echo "=== ì™„ì „ ë…ë¦½í˜• ë¹Œë“œë¥¼ ìœ„í•œ ì˜ì¡´ì„± ì„¤ì¹˜ ==="
        python3 -m pip install --upgrade pip wheel setuptools

        # ëª¨ë“  í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
        pip install -r requirements.txt

        # PyInstaller ì„¤ì¹˜ (ì™„ì „ ë…ë¦½ ì‹¤í–‰íŒŒì¼ ìƒì„±ìš©)
        pip install pyinstaller==6.2.0

        # macOS íŠ¹í™” ë„êµ¬ë“¤
        pip install dmgbuild==1.6.1

    - name: ğŸ” Pre-build Verification
      run: |
        echo "=== ë¹Œë“œ ì „ ê²€ì¦ ==="
        python3 --version
        pip list | grep -E "(PyQt6|pandas|numpy|pyinstaller)"

        echo "=== íŒŒì¼ êµ¬ì¡° í™•ì¸ ==="
        ls -la
        test -f gui_perfect.py && echo "âœ… gui_perfect.py" || exit 1
        test -f main.py && echo "âœ… main.py" || exit 1
        test -f .env && echo "âœ… .env" || exit 1
        test -d src && echo "âœ… src/" || exit 1

        echo "=== Import í…ŒìŠ¤íŠ¸ ==="
        python3 -c "import PyQt6; print('âœ… PyQt6')"
        python3 -c "import pandas; print('âœ… pandas')"
        python3 -c "import numpy; print('âœ… numpy')"
        python3 -c "import sklearn; print('âœ… scikit-learn')"
        python3 -c "import requests; print('âœ… requests')"

    - name: ğŸ—ï¸ Create PyInstaller Spec
      run: |
        echo "=== PyInstaller ìŠ¤í™ íŒŒì¼ ìƒì„± ==="

        cat > carry_optimizer.spec << 'EOF'
        # -*- mode: python ; coding: utf-8 -*-

        import sys
        from pathlib import Path

        block_cipher = None

        # ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸
        a = Analysis(
            ['gui_perfect.py'],
            pathex=['.', 'src'],  # src ê²½ë¡œ ì¶”ê°€
            binaries=[],
            datas=[
                ('src', 'src'),  # í•µì‹¬: gui_perfect.pyê°€ ì§ì ‘ importí•˜ëŠ” ëª¨ë“  ëª¨ë“ˆë“¤
                ('.env', '.'),   # í•µì‹¬: í™˜ê²½ì„¤ì • íŒŒì¼
                # main.pyì™€ batch_process.pyëŠ” GUIì—ì„œ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì œì™¸
                # ëª¨ë“  í…ŒìŠ¤íŠ¸/ê²€ì¦ íŒŒì¼ë“¤ (check_*, test_*) ì œì™¸
                # ê³¼ê±° GUI ë²„ì „ë“¤ (gui_main.py, gui_pyqt.py, mac_gui.py) ì œì™¸
                # ë³´ì¡° ë„êµ¬ë“¤ (setup_mac.py, main_simple.py, geocode_only.py) ì œì™¸
            ],
            hiddenimports=[
                # GUI í”„ë ˆì„ì›Œí¬ - ì™„ì „í•œ PyQt6 ëª¨ë“ˆ ë¦¬ìŠ¤íŠ¸
                'PyQt6.QtCore',
                'PyQt6.QtWidgets',
                'PyQt6.QtGui',
                'PyQt6.sip',
                'PyQt6.QtPrintSupport',
                # ë°ì´í„° ì²˜ë¦¬
                'pandas',
                'pandas.io.excel._xlrd',
                'pandas.io.excel._openpyxl',
                'pandas.io.parsers.readers',
                'numpy',
                'numpy.core._multiarray_umath',
                'sklearn',
                'sklearn.cluster',
                'sklearn.cluster._kmeans',
                # Excel íŒŒì¼ ì²˜ë¦¬ - ì™„ì „í•œ ë¦¬ìŠ¤íŠ¸
                'openpyxl',
                'openpyxl.workbook',
                'openpyxl.worksheet',
                'openpyxl.cell',
                'xlrd',  # Excel íŒŒì¼ ì½ê¸° (ëˆ„ë½ë˜ì—ˆë˜ ì¤‘ìš” ëª¨ë“ˆ!)
                'xlrd.biffh',
                'xlrd.sheet',
                'xlrd.book',
                'xlsxwriter',
                # ë„¤íŠ¸ì›Œí¬ ë° API - ì™„ì „í•œ requests ì˜ì¡´ì„±
                'requests',
                'requests.adapters',
                'requests.auth',
                'requests.cookies',
                'requests.models',
                'requests.sessions',
                'urllib3',
                'urllib3.util',
                'urllib3.util.retry',
                'certifi',
                'chardet',
                'idna',
                # ì§€ë„ ë° ì‹œê°í™”
                'folium',
                'folium.plugins',
                'branca',
                'branca.colormap',
                'jinja2',
                'jinja2.ext',
                'markupsafe',
                # CLI ë° í™˜ê²½
                'click',
                'click.core',
                'dotenv',
                'python_dotenv',
                # í…ŒìŠ¤íŠ¸ (ëŸ°íƒ€ì„ì— í•„ìš”í•  ìˆ˜ ìˆìŒ)
                'pytest',
                # src ëª¨ë“ˆë“¤ - gui_perfect.pyê°€ ì§ì ‘ importí•˜ëŠ” ëª¨ë“ˆë“¤
                'src',
                'src.route_optimizer',
                'src.excel_handler',
                'src.geocoder',
                'src.logger_config',
                'src.global_route_optimizer',
                'src.batch_processor',
                'src.kakao_api_client',
                'src.coordinate_utils',
                'src.map_visualizer',
                # gui_perfect.pyê°€ ì§ì ‘ importí•˜ëŠ” ëª¨ë“ˆë“¤ (root ë””ë ‰í† ë¦¬ ê¸°ì¤€)
                'excel_handler',  # src.excel_handlerì™€ ë™ì¼í•˜ì§€ë§Œ ì§ì ‘ importìš©
                'geocoder',       # src.geocoderì™€ ë™ì¼í•˜ì§€ë§Œ ì§ì ‘ importìš©
                'route_optimizer', # src.route_optimizerì™€ ë™ì¼í•˜ì§€ë§Œ ì§ì ‘ importìš©
                'logger_config',   # src.logger_configì™€ ë™ì¼í•˜ì§€ë§Œ ì§ì ‘ importìš©
                # Python í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ëª…ì‹œì  í¬í•¨)
                'json',
                'csv',
                'datetime',
                'pathlib',
                'threading',
                'multiprocessing',
                'logging',
                'logging.handlers',
                'os',
                'sys',
                'time',
                'traceback',
                'collections',
                'itertools',
                'functools',
                'typing',
                # ê¸°íƒ€ í•„ìˆ˜ ëª¨ë“ˆë“¤
                'pkg_resources',
                'setuptools',
                'six',
                'pytz',
                'dateutil',
                'dateutil.parser',
            ],
            hookspath=[],
            hooksconfig={},
            runtime_hooks=[],
            excludes=[],
            win_no_prefer_redirects=False,
            win_private_assemblies=False,
            cipher=block_cipher,
            noarchive=False,
        )

        pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

        exe = EXE(
            pyz,
            a.scripts,
            a.binaries,
            a.zipfiles,
            a.datas,
            [],
            name='CARRY Route Optimizer',
            debug=False,
            bootloader_ignore_signals=False,
            strip=False,
            upx=True,
            upx_exclude=[],
            runtime_tmpdir=None,
            console=False,
            disable_windowed_traceback=False,
            argv_emulation=False,
            target_arch=None,
            codesign_identity=None,
            entitlements_file=None,
            icon=None,
        )

        app = BUNDLE(
            exe,
            name='CARRY Route Optimizer.app',
            icon=None,
            bundle_identifier='com.carry.routeoptimizer',
            version='1.0.0',
            info_plist={
                'CFBundleDisplayName': 'CARRY Route Optimizer',
                'CFBundleName': 'CARRY Route Optimizer',
                'CFBundleVersion': '1.0.0',
                'CFBundleShortVersionString': '1.0.0',
                'NSHighResolutionCapable': True,
                'NSAppleEventsUsageDescription': 'CARRY Route Optimizer needs access for route optimization.',
                'NSLocationWhenInUseUsageDescription': 'Location access for better route optimization.',
                'LSMinimumSystemVersion': '10.15.0',
            },
        )
        EOF

        echo "âœ… PyInstaller ìŠ¤í™ íŒŒì¼ ìƒì„± ì™„ë£Œ"

    - name: ğŸ”¨ Build with PyInstaller
      run: |
        echo "=== PyInstallerë¡œ ì™„ì „ ë…ë¦½ ì‹¤í–‰íŒŒì¼ ë¹Œë“œ ==="

        # PyInstaller ì‹¤í–‰
        pyinstaller carry_optimizer.spec --clean --noconfirm

        # ë¹Œë“œ ê²°ê³¼ í™•ì¸
        if [[ -d "dist/CARRY Route Optimizer.app" ]]; then
            echo "âœ… PyInstaller ë¹Œë“œ ì„±ê³µ!"

            echo "=== ì•± ë²ˆë“¤ ì •ë³´ ==="
            ls -la "dist/CARRY Route Optimizer.app/Contents/"

            echo "=== ì•± í¬ê¸° ==="
            du -sh "dist/CARRY Route Optimizer.app"

            echo "=== ë²ˆë“¤ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸ ==="
            find "dist/CARRY Route Optimizer.app" -name "*.dylib" | head -5

        else
            echo "âŒ PyInstaller ë¹Œë“œ ì‹¤íŒ¨"
            echo "ë¹Œë“œ ë¡œê·¸:"
            cat build/*/warn-*.txt || echo "ë¡œê·¸ ì—†ìŒ"
            exit 1
        fi

    - name: ğŸ§ª App Bundle Validation
      run: |
        echo "=== ì•± ë²ˆë“¤ ê²€ì¦ ==="

        APP_PATH="dist/CARRY Route Optimizer.app"

        # êµ¬ì¡° ê²€ì¦
        test -f "$APP_PATH/Contents/Info.plist" && echo "âœ… Info.plist" || echo "âŒ Info.plist ëˆ„ë½"
        test -f "$APP_PATH/Contents/MacOS/CARRY Route Optimizer" && echo "âœ… ì‹¤í–‰íŒŒì¼" || echo "âŒ ì‹¤í–‰íŒŒì¼ ëˆ„ë½"

        # ì˜ì¡´ì„± ê²€ì¦ (ì™„ì „ ë…ë¦½í˜•ì¸ì§€ í™•ì¸)
        echo "=== ë²ˆë“¤ëœ Python ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸ ==="
        find "$APP_PATH" -name "*pandas*" | head -3
        find "$APP_PATH" -name "*numpy*" | head -3
        find "$APP_PATH" -name "*PyQt*" | head -3

        # ì‹¤í–‰ ê¶Œí•œ í™•ì¸
        if [[ -x "$APP_PATH/Contents/MacOS/CARRY Route Optimizer" ]]; then
            echo "âœ… ì‹¤í–‰ ê¶Œí•œ ì •ìƒ"
        else
            echo "âŒ ì‹¤í–‰ ê¶Œí•œ ì—†ìŒ"
            chmod +x "$APP_PATH/Contents/MacOS/CARRY Route Optimizer"
        fi

    - name: ğŸ“¦ Create Perfect PKG
      run: |
        echo "=== ì™„ë²½í•œ PKG ì¸ìŠ¤í†¨ëŸ¬ ìƒì„± ==="

        APP_NAME="CARRY Route Optimizer.app"
        PKG_NAME="CARRY-Route-Optimizer-PERFECT-$(date +%Y%m%d).pkg"

        # ì•±ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        if [[ ! -d "dist/$APP_NAME" ]]; then
            echo "âŒ ì•± ë²ˆë“¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
        fi

        # PKG í˜ì´ë¡œë“œ ì¤€ë¹„
        mkdir -p pkg_payload/Applications
        cp -R "dist/$APP_NAME" pkg_payload/Applications/

        # ì„¤ì¹˜ í›„ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        mkdir -p pkg_scripts
        cat > pkg_scripts/postinstall << 'EOF'
        #!/bin/bash

        APP_PATH="/Applications/CARRY Route Optimizer.app"

        echo "CARRY Route Optimizer ì„¤ì¹˜ í›„ ì²˜ë¦¬ ì¤‘..."

        # ê¶Œí•œ ì„¤ì •
        if [[ -d "$APP_PATH" ]]; then
            chmod -R 755 "$APP_PATH"
            chown -R root:admin "$APP_PATH"

            # Gatekeeper ì†ì„± ì œê±°
            xattr -cr "$APP_PATH" 2>/dev/null || true

            echo "âœ… CARRY Route Optimizer ì„¤ì¹˜ ì™„ë£Œ"
            echo "ğŸ“ Applications í´ë”ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤"
        else
            echo "âŒ ì„¤ì¹˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
            exit 1
        fi

        exit 0
        EOF

        chmod +x pkg_scripts/postinstall

        # PKG ìƒì„±
        pkgbuild \
            --root pkg_payload \
            --scripts pkg_scripts \
            --identifier com.carry.routeoptimizer.perfect \
            --version 1.0.0 \
            --install-location / \
            "$PKG_NAME"

        # PKG ê²€ì¦
        if [[ -f "$PKG_NAME" ]]; then
            echo "ğŸ‰ ì™„ë²½í•œ PKG ìƒì„± ì„±ê³µ!"
            echo "================================"
            echo "ğŸ“¦ íŒŒì¼ëª…: $PKG_NAME"
            echo "ğŸ“Š í¬ê¸°: $(du -sh "$PKG_NAME" | cut -f1)"
            echo "ğŸ”— ì‹ë³„ì: com.carry.routeoptimizer.perfect"
            echo ""
            echo "âœ¨ íŠ¹ì§•:"
            echo "â€¢ ì™„ì „ ë…ë¦½í˜• - Python ì„¤ì¹˜ ë¶ˆí•„ìš”"
            echo "â€¢ ëª¨ë“  ì˜ì¡´ì„± ë²ˆë“¤ë§ë¨"
            echo "â€¢ ë”ë¸”í´ë¦­ ì„¤ì¹˜ í›„ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥"
            echo "â€¢ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ë¶ˆí•„ìš”"

            # íŒ¨í‚¤ì§€ ë‚´ìš© ê²€ì¦
            echo ""
            echo "ğŸ“‹ íŒ¨í‚¤ì§€ ë‚´ìš©:"
            pkgutil --payload-files "$PKG_NAME" | head -10

        else
            echo "âŒ PKG ìƒì„± ì‹¤íŒ¨"
            exit 1
        fi

    - name: ğŸ¯ Upload Perfect PKG
      uses: actions/upload-artifact@v4
      with:
        name: CARRY-Route-Optimizer-PERFECT
        path: |
          *.pkg
          dist/CARRY Route Optimizer.app
        retention-days: 30

    - name: âœ… Perfect Build Summary
      run: |
        echo "ğŸ† ì™„ë²½í•œ PKG ë¹Œë“œ ì™„ë£Œ!"
        echo "============================="
        echo ""
        echo "ğŸ¯ ìƒì„±ëœ íŒŒì¼:"
        ls -la *.pkg
        echo ""
        echo "ğŸ’¯ ì™„ë²½í•œ íŠ¹ì§•:"
        echo "â€¢ âœ… Python ì¸í„°í”„ë¦¬í„° ë‚´ì¥"
        echo "â€¢ âœ… ëª¨ë“  ì˜ì¡´ì„± ë²ˆë“¤ë§ (pandas, numpy, PyQt6 ë“±)"
        echo "â€¢ âœ… ì™„ì „ ë…ë¦½ ì‹¤í–‰ - ì™¸ë¶€ ì„¤ì¹˜ ë¶ˆí•„ìš”"
        echo "â€¢ âœ… ë”ë¸”í´ë¦­ ì„¤ì¹˜ í›„ ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥"
        echo "â€¢ âœ… macOS ë„¤ì´í‹°ë¸Œ ì•± ê²½í—˜"
        echo "â€¢ âœ… Gatekeeper í˜¸í™˜"
        echo ""
        echo "ğŸš€ ì´ì œ ì§„ì§œë¡œ ì™„ë²½í•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤!"